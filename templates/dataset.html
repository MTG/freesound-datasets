{% extends "base.html" %}
{% load staticfiles %}
{% load humanize %}
{% block title %}About{% endblock title %}
{% block page_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            loadDatasetReleasesTable();
            loadDatasetTaxonomyTable();
            {% if dataset_release_form_errors %}
                $('#make_release_modal').modal('show');
            {% endif %}
        });

        function loadDatasetTaxonomyTable(){
            $( "#dataset_taxonomy_table_placeholder" ).load( "{% url 'taxonomy-table' dataset.short_name %}", function() {
                $('#dataset_contents').DataTable({
                    'paging': true,
                    'info': true,
                });
            });
        }

        function loadDatasetReleasesTable() {
            $( "#dataset_releases_table_placeholder" ).load( "{% url 'releases-table' dataset.short_name %}", function() {
                startUpdatingPercentages();
            });
        }

        function updateReleasePercentages() {
            n_polling_checks += 1;
            $.get( "{% url 'check-release-progresses' dataset.short_name %}", function( data ) {

                // First check if all releases are complete
                var allComplete = true;
                for (var key in data) {
                    if (data.hasOwnProperty(key)) {
                        if (data[key] != 100) {
                            allComplete = false;
                        }
                    }
                }

                // If all releases are complete at first check, there is no progress to track, cancel timer
                if (allComplete && n_polling_checks === 1){
                    window.clearInterval(polling_timer);
                    polling_timer = undefined;
                    n_polling_checks = 0;
                } else {
                    // If not all are complete or we're at later polling check, update progress bars
                    for (var key in data) {
                        if (data.hasOwnProperty(key)) {
                            $('#release_percentage_bar_' + key).progress({
                                percent: data[key],
                                text: {active: '{percent}%'}
                            });
                            if (data[key] == 100) {
                                // If one of them has reached 100, we reload the releases table
                                loadDatasetReleasesTable();
                            }
                        }
                    }
                }
            });
        }

        var polling_timer = undefined;
        var n_polling_checks = 0;
        function startUpdatingPercentages(){
            if (polling_timer === undefined) {
                polling_timer = setInterval(function(){ updateReleasePercentages(); }, 1000);
            }
        }
    </script>
{% endblock %}
{% block content %}
    <h1 class="ui header">About the {{ dataset.name }}</h1>
    {{ dataset.description_html|safe }}
    <p>
        <div id="dataset_releases_table_placeholder">
            <div class="ui active centered inline text loader">Loading data...</div>
        </div>
    </p>
    {% if user_is_maintainer %}
        <button onclick="$('#make_release_modal').modal('show');" class="green ui button right labeled icon right floated">Make new release <i class="add icon"></i></button>
        <!-- make release modal -->
            <div id="make_release_modal" class="ui modal">
                <div class="header">
                    Make a new release for {{ dataset.name }}
                </div>
                <div class="content">
                    <form id="make_release_form" class="ui form" method="post" action=".">{% csrf_token %}
                        <p>Please introduce a tag for the release (i.e. version number)</p>
                        <p>
                            {{ dataset_release_form }}
                        </p>
                        <p><button class="right floated ui green button" type="submit">OK</button><br></p>
                    </form>
                </div>
            </div>
        <!-- end make release modal -->
    {% endif %}
    <br>
    <h2>Taxonomy labels</h2>
    <div id="dataset_taxonomy_table_placeholder">
        <div class="ui active centered inline text loader">Loading data...</div>
    </div>
{% endblock %}
