{% extends "base.html" %}
{% load staticfiles %}
{% load humanize %}
{% block title %}{{dataset.short_name|upper}}{% endblock title %}
{% block page_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            loadDatasetReleasesTable();
            {% if dataset_release_form_errors %}
                $('#make_release_modal').modal('show');
            {% endif %}
            $('.menu .item').tab();
        });

        function loadDatasetReleasesTable() {
            $( "#dataset_releases_table_placeholder" ).load( "{% url 'releases-table' dataset.short_name %}", function() {
                {% if user_is_maintainer %}
                    startUpdatingPercentages();
                {% endif %}
            });
        }

        function updateReleasePercentages() {
            n_polling_checks += 1;
            $.get( "{% url 'check-release-progresses' dataset.short_name %}", function( data ) {

                // First check if there is any data returned, if not stop the polling (no releases)
                if ($.isEmptyObject(data)){
                    window.clearInterval(polling_timer);
                    polling_timer = undefined;
                    n_polling_checks = 0;
                    return;
                }

                // First check if all releases are complete
                var allComplete = true;
                for (var key in data) {
                    if (data.hasOwnProperty(key)) {
                        if (data[key] != 100) {
                            allComplete = false;
                        }
                    }
                }

                // If all releases are complete at first check, there is no progress to track, cancel timer
                if (allComplete && n_polling_checks === 1){
                    window.clearInterval(polling_timer);
                    polling_timer = undefined;
                    n_polling_checks = 0;
                } else {
                    if (allComplete && n_polling_checks > 1){
                        // If all are complete and we checked more than once, this means that those which
                        // were progressing have now finished
                        loadDatasetReleasesTable();
                        n_polling_checks = 0;
                    }
                    // If not all are complete or we're at later polling check, update progress bars
                    for (var key in data) {
                        if (data.hasOwnProperty(key)) {
                            $('#release_percentage_bar_' + key).progress({
                                percent: data[key],
                                text: {active: '{percent}%'}
                            });
                        }
                    }
                }
            });
        }

        var polling_timer = undefined;
        var n_polling_checks = 0;
        function startUpdatingPercentages(){
            if (polling_timer === undefined) {
                polling_timer = setInterval(function(){ updateReleasePercentages(); }, 1000);
            }
        }
    </script>
{% endblock %}
{% block content %}
    <h1 class="ui header">About the {{ dataset.name }} ({{dataset.short_name|upper}})</h1>
    <p>
        {{ dataset.name }} ({{ dataset.short_name|upper }}) is a large-scale, general-purpose audio dataset.
        It consists of audio samples from <a target="_blank" href="http://freesound.org/">Freesound</a> organised in
        the hierarchy of <a target="_blank" href="https://research.google.com/audioset/">Google's AudioSet</a> Ontology,
        which includes {{dataset.taxonomy.get_num_nodes}} classes. We have mapped a total of <b>{{ dataset.num_sounds|intcomma }}
        samples</b> to the AudioSet Ontology. The mapping generated <b>{{ dataset.num_annotations|intcomma }} annotations</b>
        which express the potential presence of a sound source in an audio sample. You can find more information in our
        <a target="_blank" href="https://ismir2017.smcnus.org/wp-content/uploads/2017/10/161_Paper.pdf">ISMIR 2017 paper</a>
        and you can contact us via <a target="_top" href="mailto:mtg@upf.edu">mail</a> for issues related to
        {{ dataset.short_name|upper}}.
    </p>
    <p>
        In order to make {{ dataset.short_name|upper }} reliable enough for research, we need to <b>validate these
        automatically generated annotations</b> and we aim to achieve it through <b>crowdsourcing</b>. If you wish to
        contribute by validating annotations and <i>make the world a better place</i>, please visit our
        <a target="_blank" href="{% url 'contribute' dataset.short_name %}">Annotate</a> page.
    </p>
    <p>
        Thanks to the community, we intend to improve {{ dataset.short_name|upper}} over time in terms of quality
        (better ground truth annotations), and quantity (larger amounts of data). Therefore, there will be consecutive
        <b>releases</b> of {{ dataset.short_name|upper}}. We are now in the process of gathering annotations to build
        the first {{ dataset.short_name|upper}} release. Releases (including waveforms, pre-computed features and
        metadata) will be available for download from our
        {% if dataset.last_release_tag %}
            <a href="{% url 'download-release' dataset.short_name dataset.last_release_tag %}">Download</a>
        {% else %}
            <a href="#" onclick="return false;" style="color:#888888;">Download</a>
        {% endif %}


        page under Creative Commons licenses.
    </p>
    <p>
        The following Table shows the current annotation state of the mapped data, which will be updated with the
        consecutive releases when available. Please hover your mouse over the Table header to see the definitions of
        some parameters.
    </p>
    <p>
        <div id="dataset_releases_table_placeholder">
            <div class="ui active centered inline text loader">Loading data...</div>
        </div>
    </p>
    {% if user_is_maintainer %}
        <button onclick="$('#make_release_modal').modal('show');" class="green ui button right labeled icon right floated">Make new release <i class="add icon"></i></button>
        <!-- make release modal -->
            <div id="make_release_modal" class="ui modal">
                <div class="header">
                    Make a new release for {{ dataset.name }}
                </div>
                <div class="content">
                    <form id="make_release_form" class="ui form" method="post" action=".">{% csrf_token %}
                        {{ dataset_release_form.as_p }}
                        <p><button class="right floated ui green button" type="submit">OK</button><br></p>
                    </form>
                </div>
            </div>
        <!-- end make release modal -->
    {% endif %}
{% endblock %}
