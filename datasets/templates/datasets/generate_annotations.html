{% extends 'base.html' %}

{% load staticfiles %}
{% load general_templatetags %}
{% load dataset_templatetags %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static "css/exploreTaxonomy.css" %}"/>
    <script src="{% static "taxonomy-explorer/js/load-taxonomy.js" %}" type="text/javascript"></script>
    {% load_sound_player_files %}
{% endblock %}

{% block title %}Generate annotations{% endblock %}

{% block page_js %}
<script type="text/javascript">

    $(function () {
        TT = new TaxonomyTree({
{#            url: "{% static "taxonomy-explorer/taxonomy-tree.json" %}",#}
            url: "{% url 'taxonomy-tree' dataset.short_name %}",
            container: "#taxonomy-tree",
            skipCategories: ["Ontology"],
            generation_task: {{ generation_task }}
        });
        TT.load();
    });

</script>
{% endblock %}

{% block content %}
    <script type="text/javascript">
    var currentPromise = $.Deferred().resolve().promise();
    function displayResults(numberOfRes, text) {
        var resDiv = $(".results");

        var searchPromise = $.ajax({
            url: "{% url 'search-taxonomy-node' dataset.short_name %}?q="+text.value,
            type: "GET"
        });

        var thenPromise = currentPromise.then(
            function () { return searchPromise;},
            function () { return searchPromise;});

        currentPromise = thenPromise;

        thenPromise.done( function(data){
            resDiv.empty();
            for (var i=0; i<data.length;i++) {
                var el = $("<a class='ui teal large label' style='margin:2px;' big-id="+ data[i].big_id +">"+data[i].path+"</a>");
                resDiv.append(el);
                el.click(function() {
                    TT.locateCategory($(this).attr('big-id'));
                });
        }});
        thenPromise.fail( function(){ console.log('failure'); } );
    }

    function getAddedGroupLabels() {
        var addedGroupLabelIds = [];
        var addedGroupLabelNames = [];
        $('.added-label').each(function() {
            addedGroupLabelIds.push();
            addedGroupLabelNames.push($(this).attr('label-name'));
        });
        return [addedGroupLabelIds, addedGroupLabelNames]
    }

    function submitForm() {
        var addedGroupLabels = getAddedGroupLabels();
        var labelIds = addedGroupLabels[0];
        var labelNames = addedGroupLabels[1];
        var labelVotes = addedGroupLabels[2];
        var jsonData = JSON.stringify({
            freesound_sound_id: "{{ freesound_sound_id }}",
            labelIds: labelIds,
            labelNames: labelNames,
            labelVotes: labelVotes
        });
        var data = {
               jsonData : jsonData,
               csrfmiddlewaretoken: "{{csrf_token}}"
            };
        $.ajax({
            type: "POST",
            url: "{% url 'save-contribute-generate-annotations' dataset.short_name %}",
            data: data,
            traditional:true
        }).done(function(result) {
            document.getElementById("submitButton").disabled = true;
        });
    }
    </script>
    <div class="ui basic segment">
        <center>
            <h3>Listen to the following sound and add labels!</h3>
            {{ freesound_sound_id| fs_embed_large | safe }}
        </center>
        <br>

        <div class="ui right rail">
            <h3>Added labels</h3>
            <div id="label-container"></div>
            <button id="submitButton" class="ui green big button" onclick="submitForm();">Submit</button>
        </div>

        <center>

        </center>
        <br>

        <div class="ui icon input">
            <input placeholder="Search..." type="search" oninput="displayResults(5, this)">
            <i class="search icon"></i>
        </div>
        <div class="ui results">
        </div>
        <br>
        <div id="taxonomy-tree">
        </div>
    </div>
{% endblock %}