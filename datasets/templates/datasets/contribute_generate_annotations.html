{% extends "base.html" %}
{% load staticfiles %}
{% load dataset_templatetags %}
{% block title %}Generate annotations{% endblock title %}
{% block page_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            getHierarchyPathsAndNameId();
            loadDatasetTaxonomyTable();
            loadDatasetTaxonomyTableChoose(0);
            $('.menu .item').tab();
        });

        function uniq(a) {
            var hash = {};
            var out = [];
            for (var i = 0, l = a.length; i < l; i++) {
                var key = a[i].join('|');
                if (!hash[key]) {
                    out.push(a[i]);
                    hash[key] = 'found';
                }
            }
            return out
        }

        function getHierarchyPathsAndNameId() {
            $.ajax({url: "{% url 'get_hierachy_paths' dataset.short_name %}",
                type: "GET",
                success: function(result) {
                    hierarchy_paths = result.hierachy_paths;
                    id_to_name = result.id_to_name;
                    id_to_ajax = result.id_to_ajax;
                }
            });
        }

        function searchPaths(node_id) {
            var found_paths = [];
            for (j=0; j < hierarchy_paths.length; j++) {
                var found = hierarchy_paths[j].find(k => k === node_id);
                if (found) found_paths.push(hierarchy_paths[j]);
            }
            return found_paths
        }

        function parentPaths(paths, node_id) {
            var parent_paths = [];
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                parent_paths.push(paths[i].slice(0, index));
            }
            return uniq(parent_paths)
        }

        function childrenPaths(paths, node_id) {
            var children_paths = [];
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                children_paths.push(paths[i].slice(index+1, paths[i].length));
            }
            return children_paths
        }

        function getParents(node_id) {
            var parents = [];
            var paths = searchPaths(node_id);
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                parents.push(paths[i][index-1]);
            }
            return Array.from(new Set(parents));
        }

        function getChildren(node_id) {
            var children = [];
            var paths = searchPaths(node_id);
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                if (paths[i][index+1] !== undefined) {
                    children.push(paths[i][index + 1]);
                }
            }
            return Array.from(new Set(children));
        }

        function getSiblings(node_id) {
            var siblings = [];
            var parents = getParents(node_id);
            for (var i=0; i < parents.length; i++) {
                Array.prototype.push.apply(siblings, getChildren(parents[i]));
            }
            return Array.from(new Set(siblings))
        }

        function addPopUpEvent(targets) {
            var popupLoading = '<div style="height:130px; width:400px" class="ui loading segment">Loading</div>';
            $('.my-pop').ready(function() {
                if (typeof targets === 'undefined') {
                    var my_pops = $('.my-pop[event-added=0]');
                } else {
                    var my_pops = targets;
                }
                my_pops.attr('event-added', 1);
                my_pops.popup({
                    position: 'top right',
                    on: 'hover',
                    html: popupLoading,
                    hoverable: true,
                    onShow: function(el){
                        var ajax_done = el.getAttribute('ajax_done');
                        if (ajax_done == 0) {
                            var popup = this;
                            var ajax_url = el.getAttribute('ajax_url').replace('se=0', 'se=1') + '&sh=0' + '&sn=0';
                            $.ajax({
                                url: ajax_url
                            }).done(function(result) {
                                el.setAttribute("data-html", result);
                                el.setAttribute("ajax_done", 1);
                                popup.html(result);
                            }).fail(function() {
                                popup.html('error')
                            });
                        }
                    }
                });
            });
        }

        function addLabelGroups(label_name, label_id) {
            // add all the group label corresponding to the selected label (multiple parents creates several label groups)
            var paths = searchPaths(label_id);
            var parent_paths = parentPaths(paths, label_id);
            for (var i=0; i < parent_paths.length; i++) {
                var group_id = label_id + i;
                addLabelGroup(parent_paths[i], group_id, label_name, label_id);
            }
        }

        function addLabelGroup(path, group_id, label_name, label_id) {
            $('#label-container').append('<div class="group-label ui message" group-id="'+ group_id +'"><i class="close icon"></i></div>');
            for (var j=0; j < path.length; j++) {
                addLabel(id_to_name[path[j]], path[j], group_id);
                $('div[group-id="'+group_id+'"]').append('>');
            }
            addLastLabel(label_name, label_id,  group_id);
            addChildrenLabel(label_name, label_id,  group_id);
            addLabelGroupClickEvent(group_id);
        }

        function updateLabelGroup(group_id, old_label_id, new_label_id) {
            var group_div = $('div[group-id="'+group_id+'"]');
            var path = group_div.find('.generated-label').attrs('label-id');
            var idx = path.indexOf(old_label_id);
            path[idx] = new_label_id;
            group_div.empty();
            $('button[label-name="'+id_to_name[old_label_id]+'"]').prop( "disabled", false );
            group_div.append('<i class="close icon"></i>');
            for (var j=0; j < idx; j++) {
                addLabel(id_to_name[path[j]], path[j], group_id);
                group_div.append('>');
            }
            var label_name = id_to_name[new_label_id];
            addLastLabel(label_name, new_label_id, group_id);
            addChildrenLabel(label_name, new_label_id, group_id);
            addLabelGroupClickEvent(group_id);
        }

        function removeLabelGroup(group_id) {
            var group_div = $('div[group-id="'+group_id+'"]');
            var children = group_div.children('.generated-label');
            for (i=0 ; i<children.length; i++) {
                removeLabel(children.eq(i).attr('label-name'));
            }
            group_div.remove();
        }

        function addLabel(label_name, label_id, group_id) {
            $('div[group-id="'+group_id+'"]').append('<div class="generated-label ui large label" label-name="'
                                                     + label_name+'" label-id="'+ label_id +'">'+label_name+'</div>');
            $('button[label-name="'+label_name+'"]').prop( "disabled", true );
        }

        function addLastLabel(label_name, label_id, group_id) {
            var siblings = getSiblings(label_id);
            var ajax_url = getEncodedUrl(label_id);
{#            var ajax_url = $('button[label-id="'+label_id+'"]').parents('tr').find('.my-pop').attr('ajax_url');#}
            var el = '';
            el += '<div class="current generated-label ui compact inverted blue inline scrolling dropdown button" label-name="';
            el += label_name + '" ';
            el += 'label-id="'+ label_id +'">';
            el += '<div class="text">' + label_name;
            el += '<span class="my-pop ui" event-added=0 data-html="" ajax_done=0 style="margin-left:5px;" ajax_url="';
            el += ajax_url;
            el += '"><i class="help inverted blue circle icon"></i></span>';
            el += '</div>';
            el += '<i class="dropdown icon"></i>';
            el += '<div class="menu">';
            for (var i=0; i < siblings.length; i++) {
                ajax_url = getEncodedUrl(siblings[i]);
{#                ajax_url = $('button[label-id="'+siblings[i]+'"]').parents('tr').find('.my-pop').attr('ajax_url');#}
                el += '<div data-value="'+ siblings[i] +'" class="item" label-id="'+ siblings[i] +'">'
                    + id_to_name[siblings[i]]
                    + '<span class="my-pop ui" event-added=0 data-html="" ajax_done=0 style="margin-left:5px;" ajax_url="'
                    + ajax_url
                    + '"><i class="help grey circle icon"></i></span>'
                    + '</div>';
            }
            el += '</div>';

            $('div[group-id="'+group_id+'"]').append(el);
            $('div[group-id="'+group_id+'"] > .current').dropdown({
                onChange: function(value, text, $selectedItem) {
                    // update label attributes
                    var current_label = $selectedItem.parents('.generated-label');
                    var old_label_id = current_label.attr('label-id');
                    var new_label_id = value;
                    // update label group
                    updateLabelGroup(group_id, old_label_id, new_label_id);

                },
                onHide: function() {
                    // don't hide the dorpdown when clicking on an popup (= when a popup is visible)
                    return $('.my-pop.visible').length === 0
                }
            });
            addPopUpEvent();
            $('button[label-name="'+label_name+'"]').prop( "disabled", true );
        }

        function addChildrenLabel(label_name, label_id, group_id) {
            var children = getChildren(label_id);
            var ajax_url;
            if (children.length > 0) {
                var el = '>';
                el += '<div class="children generated-label ui compact inverted blue inline scrolling dropdown button" label-name=""';
                el += 'label-id="">';
                el += '<div class="text"> Select';
                el += '</div>';
                el += '<i class="dropdown icon"></i>';
                el += '<div class="menu">';
                for (var i=0; i < children.length; i++) {
                    ajax_url = getEncodedUrl(children[i]);
{#                        $('button[label-id="'+children[i]+'"]').parents('tr').find('.my-pop').attr('ajax_url');#}
                    el += '<div data-value="'+ children[i] +'" class="item" label-id="'+ children[i] +'">'
                        + id_to_name[children[i]]
                        + '<span class="my-pop ui" event-added=0 data-html="" ajax_done=0 style="margin-left:5px;" ajax_url="'
                        + ajax_url
                        + '"><i class="help grey circle icon"></i></span>'
                        + '</div>';
                }
                el += '</div>';

                $('div[group-id="'+group_id+'"]').append(el);
                $('div[group-id="'+group_id+'"] > .children').dropdown({
                    onChange: function(value, text, $selectedItem) {
                        // update label attributes
                        var current_label = $selectedItem.parents('.generated-label');
                        var old_label_id = current_label.attr('label-id');
                        var new_label_id = value;
                        // update label group
                        updateLabelGroup(group_id, old_label_id, new_label_id);
                    },
                    onHide: function() {
                        // don't hide the dorpdown when clicking on an popup (= when a popup is visible)
                        return $('.my-pop.visible').length === 0
                    }
                });
                addPopUpEvent();
                $('button[label-name="'+label_name+'"]').prop( "disabled", true );
            }
        }

        function removeLabel(label_name, group_id) {
             $('div[group-id="'+group_id+'"] > div[label-name="'+label_name+'"]').remove();
             $('button[label-name="'+label_name+'"]').prop( "disabled", false );
        }

        function addLabelGroupClickEvent(group_id) {
            var group_delete = $('div[group-id="'+group_id+'"] > i');
            group_delete.click(function() {
                removeLabelGroup(group_id);
            });
        }

        function addButtonClickEvents(targets) {
            if (typeof targets === 'undefined') {
                var my_buttons = $('.add-label-button[event-added=0]');
            } else {
                var my_buttons = targets;
            }
            my_buttons.attr('event-added', 1);
            $(my_buttons).click(function() {
                var label_name = $(this).attr('label-name');
                var label_id = $(this).attr('label-id');
                addLabelGroups(label_name, label_id);
            });
        }

        function getAddedLabels() {
            return Array.from(new Set($('.generated-label').attrs('label-id')))
        }

        function syncTables() {
            var label_ids = getAddedLabels();
            $('.add-label-button').prop( "disabled", false );
            for (var i=0; i < label_ids.length; i++) {
                $('button[label-id="'+label_ids[i]+'"]').prop( "disabled", true );
            }
        }

        function getEncodedUrl(node_id) {
            return encodeURI(id_to_ajax[node_id])
        }

        jQuery.fn.extend({
            attrs: function (attributeName) {
                var results = [];
                $.each(this, function (i, item) {
                    results.push(item.getAttribute(attributeName));
                });
                return results;
            }
        });

        function loadDatasetTaxonomyTableChoose(node_id){
            $.ajax({url: "{% url 'dataset_taxonomy_table_choose' dataset.short_name %}",
                    type: "POST",
                    beforeSend: function(){ timeoutID = setTimeout( function() {
                        $( "#choose_table_placeholder" ).html('<div class="ui active centered inline text loader">Loading data...</div>')}, 500)
                    },
                    data: {node_id: node_id, add_label_or_choose_category: 'add_label', csrfmiddlewaretoken: "{{csrf_token}}"},
                    success: function(result){
                        clearTimeout(timeoutID);
                        $( "#choose_table_placeholder" ).html(result);
                        $(".loadButton").on("click", function(e) {
                            var thisId = $(this).data("node_id");
                            loadDatasetTaxonomyTableChoose(thisId);
                        });
                        addPopUpEvent();
                        addButtonClickEvents();
                        syncTables();
                    }
            })
        }

        function loadDatasetTaxonomyTable(){
            $( "#search_table_placeholder" ).load( "{% url 'taxonomy-table-extended' dataset.short_name %}", function() {
                $('#dataset_contents').DataTable({
                    'paging': true,
                    'info': true,
                    'search': {
                        "smart": false
                    },
                    'columnDefs': [
                        {
                            "targets": [1, 2],
                            "visible": false
                        }
                    ]
                });
                $('#dataset_contents_paginate').parent().attr('style', 'width: 100% !important');
                $('#dataset_contents').on('draw.dt', function () {
                    addPopUpEvent($(this).find('.my-pop'));
                    addButtonClickEvents();
                    syncTables();
                });
                addPopUpEvent();
                addButtonClickEvents();
                syncTables();
            });
        }
    </script>
{% endblock %}
{% block content %}
    <center>
        <h3>Listen to the following sound and annotate it!</h3>
        {{ freesound_sound_id| fs_embed_large | safe }}
    </center>
    <br>
    <div class="ui grid">
        <div class="nine wide column">
            <h3>Category exploration tables</h3>
            <div class="ui segment" style="padding: 0 0 0 0;">
                <div class="ui two item top attached tabular menu">
                  <a class="item active" data-tab="first">
                      <div style="margin-left:25px;"><i class="sitemap icon big white"></i></div>
                      <div style="margin-right:15px;"><p> <b>Navigate</b> the first two levels of the ontology & choose a category</p></div>
                  </a>
                  <a class="item" data-tab="third">
                      <div style="margin-left:25px;margin-right:25px;"><i class="search icon big white"></i></div>
                      <div style="margin-right:15px;"><p><b>Search</b> a category by its name</p></div>
                  </a>
                </div>
                <div class="ui bottom attached tab segment active" data-tab="first" id="choose_table_placeholder">
                    <div class="ui active centered inline text loader">Loading data...</div>
                </div>
                <div class="ui bottom attached tab segment" data-tab="third" id="search_table_placeholder">
                    <div class="ui active centered inline text loader">Loading data...</div>
                </div>
            </div>
        </div>

        <div class="seven wide column">
            <h3>Added Labels</h3>
            <div id="label-container"></div>
        </div>
    </div>
{% endblock %}

{% block extra_head %}
    <style>
        .ui.popup {
            max-width: 400px;
        }
    </style>
{% endblock extra_head%}