{% extends "base.html" %}
{% load staticfiles %}
{% load dataset_templatetags %}
{% block title %}Generate annotations{% endblock title %}
{% block page_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            getHierarchyPathsAndNameId();
            loadDatasetTaxonomyTable();
            loadDatasetTaxonomyTableChoose(0);
            $('.menu .item').tab();
        });

        function uniq(a) {
            var hash = {};
            var out = [];
            for (var i = 0, l = a.length; i < l; i++) {
              var key = a[i].join('|');
              if (!hash[key]) {
                out.push(a[i]);
                hash[key] = 'found';
              }
            }
            return out
        }

        function getHierarchyPathsAndNameId() {
            $.ajax({url: "{% url 'get_hierachy_paths' dataset.short_name %}",
                type: "GET",
                success: function(result) {
                    hierarchy_paths = result.hierachy_paths;
                    id_to_name = result.id_to_name;
                }
            });
        }

        function searchPaths(node_id) {
            var found_paths = [];
            for (var i=0; i < hierarchy_paths.length; i++) {
                for (j=0; j < hierarchy_paths[i].length; j++) {
                    var found = hierarchy_paths[i][j].find(k => k === node_id);
                    if (found) found_paths.push(hierarchy_paths[i][j]);
                }
            }
            return found_paths
        }

        function parentPaths(paths, node_id) {
            var parent_paths = [];
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                parent_paths.push(paths[i].slice(0, index));
            }
            return uniq(parent_paths)
        }

        function childrenPaths(paths, node_id) {
            var children_paths = [];
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                children_paths.push(paths[i].slice(index+1, paths[i].length));
            }
            return children_paths
        }

        function getParents(node_id) {
            var parents = [];
            var paths = searchPaths(node_id);
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                parents.push(paths[i][index-1]);
            }
            return Array.from(new Set(parents));
        }

        function getChildren(node_id) {
            var children = [];
            var paths = searchPaths(node_id);
            for (var i=0; i < paths.length; i++) {
                var index = paths[i].indexOf(node_id);
                children.push(paths[i][index+1]);
            }
            return Array.from(new Set(children));
        }

        function getSiblings(node_id) {
            var siblings = [];
            var parents = getParents(node_id);
            for (var i=0; i < parents.length; i++) {
                Array.prototype.push.apply(siblings, getChildren(parents[i]));
            }
            return Array.from(new Set(siblings))
        }

        function addPopUpEvent(targets) {
            var popupLoading = '<div style="height:180px; width:500px" class="ui loading segment">Loading</div>';
            $('.my-pop').ready(function() {
                if (typeof targets === 'undefined') {
                    var my_pops = $('.my-pop[event-added=0]');
                } else {
                    var my_pops = targets;
                }
                my_pops.attr('event-added', 1);
                my_pops.popup({
                    on: 'hover',
                    html: popupLoading,
                    onShow: function(el){
                        var ajax_done = el.getAttribute('ajax_done');
                        if (ajax_done == 0) {
                            var popup = this;
                            var ajax_url = el.getAttribute('ajax_url');
                            $.ajax({
                                url: ajax_url
                            }).done(function(result) {
                                el.setAttribute("data-html", result);
                                el.setAttribute("ajax_done", 1);
                                popup.html(result);
                            }).fail(function() {
                                popup.html('error')
                            });
                        }
                    }
                });
            });
        }

        function loadDatasetTaxonomyTableChoose(node_id){
            $.ajax({url: "{% url 'dataset_taxonomy_table_choose' dataset.short_name %}",
                    type: "POST",
                    beforeSend: function(){ timeoutID = setTimeout( function() {
                        $( "#choose_table_placeholder" ).html('<div class="ui active centered inline text loader">Loading data...</div>')}, 500)
                    },
                    data: {node_id: node_id, add_label_or_choose_category: 'add_label', csrfmiddlewaretoken: "{{csrf_token}}"},
                    success: function(result){
                        clearTimeout(timeoutID);
                        $( "#choose_table_placeholder" ).html(result);
                        $(".loadButton").on("click", function(e) {
                            var thisId = $(this).data("node_id");
                            loadDatasetTaxonomyTableChoose(thisId)
                        });
                        addPopUpEvent();
                        addButtonClickEvents();
                        // TODO: add fix sync between tables
                    }
            })
        }

        function addGroupLabel(label_name, label_id) {
            var paths = searchPaths(label_id);
            var parent_paths = parentPaths(paths, label_id);
            var children_paths = childrenPaths(paths, label_id);  // TODO: propose these labels to the user
            for (var i=0; i < parent_paths.length; i++) {
                var group_id = label_id + i;
                $('#label-container').append('<div class="group-label ui message" group-id="'+ group_id +'"><i class="close icon"></i></div>');
                for (var j=0; j < parent_paths[i].length; j++) {
                    addLabel(id_to_name[parent_paths[i][j]], parent_paths[i][j], group_id);
                    $('div[group-id="'+group_id+'"]').append('>');
                }
                addLastLabel(label_name, label_id,  group_id);
                addLabelGroupClickEvent(label_id + i);
            }
        }

        function removeGroupLabel(group_id) {
            var group_div = $('div[group-id="'+group_id+'"]');
            var children = group_div.children('.generated-label');
            for (i=0 ; i<children.length; i++) {
                removeLabel(children.eq(i).attr('label-name'));
            }
            group_div.remove();
        }

        function addLabel(label_name, label_id, group_id) {
            $('div[group-id="'+group_id+'"]').append('<div class="generated-label ui large label" label-name="'
                                                     + label_name+'">'+label_name+'</div>');
            $('button[label-name="'+label_name+'"]').prop( "disabled", true );
        }

        function addLastLabel(label_name, label_id, group_id) {
            var siblings = getSiblings(label_id);

            var el = '';
            el += '<div class="generated-label ui compact inline scrolling dropdown button" label-name="';
            el += label_name + '" ';
            el += 'label-id="'+ label_id +'">';
            el += '<div class="text">' + label_name + '</div>';
            el += '<i class="dropdown icon"></i>';
            el += '<div class="menu">';
            for (var i=0; i < siblings.length; i++) {
                el += '<div data-value="'+ siblings[i] +'" class="item" label-id="'+ siblings[i] +'">' + id_to_name[siblings[i]] + '</div>';
            }
            el += '</div>';

            $('div[group-id="'+group_id+'"]').append(el);
            $('div[group-id="'+group_id+'"] > .ui.dropdown').dropdown({
                onChange: function(value, text, $selectedItem) {
                    // update label attributes
                    var current_label = $selectedItem.parents('.generated-label');
                    var old_label_name = current_label.attr('label-name');
                    var new_label_name = id_to_name[value];
                    current_label.attr('label-id', value);
                    current_label.attr('label-name', new_label_name);
                    // update table
                    $('button[label-name="'+old_label_name+'"]').prop( "disabled", false );
                    $('button[label-name="'+new_label_name+'"]').prop( "disabled", true );
                }
            });
            $('button[label-name="'+label_name+'"]').prop( "disabled", true );
        }

        function removeLabel(label_name, group_id) {
             $('div[group-id="'+group_id+'"] > div[label-name="'+label_name+'"]').remove();
             $('button[label-name="'+label_name+'"]').prop( "disabled", false );
        }

        function addLabelGroupClickEvent(group_id) {
            var group_delete = $('div[group-id="'+group_id+'"] > i');
            group_delete.click(function() {
                removeGroupLabel(group_id);
            });
        }

        function addButtonClickEvents(targets) {
            if (typeof targets === 'undefined') {
                var my_buttons = $('.add-label-button[event-added=0]');
            } else {
                var my_buttons = targets;
            }
            my_buttons.attr('event-added', 1);
            $(my_buttons).click(function() {
                var label_name = $(this).attr('label-name');
                var label_id = $(this).attr('label-id');
                addGroupLabel(label_name, label_id);
            });
        }

        function loadDatasetTaxonomyTable(){
            $( "#search_table_placeholder" ).load( "{% url 'taxonomy-table-extended' dataset.short_name %}", function() {
                $('#dataset_contents').DataTable({
                    'paging': true,
                    'info': true,
                    'search': {
                        "smart": false
                    },
                    'columnDefs': [
                        {
                            "targets": [1, 2],
                            "visible": false
                        }
                    ]
                });
                $('#dataset_contents_paginate').parent().attr('style', 'width: 100% !important');
                $('#dataset_contents').on('draw.dt', function () {
                    addPopUpEvent($(this).find('.my-pop'));
                    addButtonClickEvents();
                });
                addPopUpEvent();
                addButtonClickEvents();
                // TODO: add fix sync between tables
            });
        }
    </script>
{% endblock %}
{% block content %}
    {{ freesound_sound_id| fs_embed | safe }}
    <div class="ui grid">
        <div class="nine wide column">
            <div class="ui segment" style="padding: 0 0 0 0;">
                <div class="ui two item top attached tabular menu">
                  <a class="item active" data-tab="first">
                      <div style="margin-left:25px;"><i class="sitemap icon big white"></i></div>
                      <div style="margin-right:15px;"><p> <b>Navigate</b> the first two levels of the ontology & choose a category</p></div>
                  </a>
                  <a class="item" data-tab="third">
                      <div style="margin-left:25px;margin-right:25px;"><i class="search icon big white"></i></div>
                      <div style="margin-right:15px;"><p><b>Search</b> a category by its name</p></div>
                  </a>
                </div>
                <div class="ui bottom attached tab segment active" data-tab="first" id="choose_table_placeholder">
                    <div class="ui active centered inline text loader">Loading data...</div>
                </div>
                <div class="ui bottom attached tab segment" data-tab="third" id="search_table_placeholder">
                    <div class="ui active centered inline text loader">Loading data...</div>
                </div>
            </div>
        </div>

        <div id="label-container" class="seven wide column">
        </div>
    </div>
{% endblock %}