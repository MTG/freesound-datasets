{% extends "base.html" %}
{% load humanize %}
{% load staticfiles %}
{% load general_templatetags %}
{% block title %}Monitor category mapping{% endblock title %}
{% block extra_head %}
    {% load_sound_player_files %}
{% endblock %}

{% block page_js %}
    <script type="text/javascript">
    $(function () {
        $(".submit-form").on("click", function () {
            submitForm();
        })
    });
    function addTagRow() {

        var container = $(".tag-inputs");

        var row = $("<div>", {
            class: "inline field tag-group-or"
        });
        var input = $("<input>", {
            type: "text",
            placeholder: "Tag string"
        });
        var button_container = $("<span>");
        var button = $("<button>", {
            class: "ui circular red icon tiny button"
        });
        var close = $("<i>", {
            class: "ui close icon"
        });

        button.append(close);
        button.on("click", function () {
            row.remove();
        });
        button_container.append(button);
        row.append([input, button_container]);
        container.append(row);

    }

    function submitForm() {

        var tag_containers = $('.tag-group-or');
        var positive_tag_list = [];
        tag_containers.each( function () {
            var input = $(this).find('input');
            positive_tag_list.push(input.val());
        });
        var preproc_positive = $('#preproc-positive').is(":checked");
        var negative_tags = $('#negative-tags').val();
        var preproc_negative = $('#preproc-negative').is(":checked");

        $.ajax({
            url: "{% url 'mapping-category' dataset.short_name node.url_id %}",
            type: "POST",
            data: {
                "positive-tags": positive_tag_list,
                "preproc-positive": preproc_positive,
                "negative-tags": negative_tags,
                "preproc-negative": preproc_negative,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            traditional: true
        })
            .done(function (d) {
                console.log(d);
                showStats(d);
            })
    }

    function showStats (data) {
        var quality_est = data.quality_estimate;
        var n_votes = data.num_votes;
        $(".curr-map-quality").text(quality_est*100);
        $(".curr-num-votes").text(n_votes);
    }
    </script>
{% endblock %}

{% block content %}
    <h1 class="ui header">Monitor the mapping of <span class="ui big label">{{ node.name }}</span></h1>

    <div class="ui raised segment" style="position: relative;">

        <h4 class="ui dividing header">
            <div class="content">
                Filter by tags
                <div class="sub header">Add the tags you want to be selected</div>
            </div>
        </h4>

        <div class="ui stackable grid">

            <div class="eight wide column">
                <div class="ui green header">Include tags</div>
                <div class="ui form">

                    <div class="tag-inputs">
                        <div class="inline field tag-group-or">
                            <label>Comma separated tags (e.g.: dog, bark, panting)</label>
                            <input type="text" placeholder="Tag string"/>
                        </div>
                    </div>

                    <button type="button" style="margin:5px;" class="ui circular blue icon button" onclick="addTagRow();">
                        <i class="ui plus icon"></i>
                        Add alternative tag group
                    </button>

                    <div class="actions">
                        <div class="ui checked checkbox">
                            <input type="checkbox" checked="" tabindex="0" name="preproc-positive" id="preproc-positive"/>
                            <label>Stem tags</label>
                        </div>
                    </div>

                </div>
            </div>

            <div class="eight wide column">
                <div class="ui form">
                    <div class="ui red header">Omit tags</div>

                    <div class="inline field">
                        <label>Comma separated tags (e.g.: dog, bark, panting)</label>
                        <input type="text" id="negative-tags" placeholder="Tag string"/>
                    </div>

                    <div class="actions">
                        <div class="ui checkbox">
                            <input type="checkbox" tabindex="0" name="preproc-negative" id="preproc-negative"/>
                            <label>Stem tags</label>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <div class="ui clearing divider"></div>

        <center>
            <div class="section">
                <button class="ui button submit-form">
                    Submit
                </button>
            </div>
        </center>

    </div>

    <div class="res-content">
        <h4 class="ui horizontal divider header">
            <i class="bar chart icon"></i>
            Inspect
        </h4>
        <div class="ui stackable grid">
            <div class="eight wide column">
                <div class="ui header">Current mapping</div>
                <div class="ui sub header">Quality: <span class="curr-map-quality"></span>%</div>
                <div class="ui sub header">Number of votes: <span class="curr-num-votes"></span></div>
            </div>

            <div class="eight wide column right aligned">
                <div class="ui header">New mapping</div>
                <div class="ui sub header">Quality: <span class="new-map-quality"></span>%</div>
                <div class="ui sub header">Number of votes: <span class="new-num-votes"></span></div>
            </div>
        </div>
    </div>

{% endblock %}