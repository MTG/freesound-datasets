{% extends "base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load general_templatetags %}
{% block title %}Monitor category page{% endblock title %}

{% block page_js %}
    <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3-axis.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v1.min.js"></script>
    <script src="https://d3js.org/d3-path.v1.min.js"></script>
    <script src="https://d3js.org/d3-shape.v1.min.js"></script>
    <script src="{% static "js/charts.js" %}"></script>">
    <script type="text/javascript">
        $(document).ready(function(){
            $('.ui.accordion').accordion();
            $('#category-table').DataTable();

            var contributions = JSON.parse('{{ num_contributions_per_day.contribution_per_day | safe }}');

            displayCharts('.contributions', [contributions], {
                yText: 'contributions',
                attrX: 'day',
                attrY: 'count',
                tickEvery: d3.timeDay.every(60),
                timeFormat:"%b %y",
                legendData:[{color: 'crimson', name: 'votes'}]
            }, {});

            var cumulative_contributions = [];
            var total_count = 0;
            // this assumes that data counts are ordered by date asc
            for (i=0; i<contributions.length; i++) {
                total_count += contributions[i].count;
                cumulative_contributions.push({
                    day: contributions[i].day,
                    count: total_count
                });
            }

            displayCharts('.cumulative-contributions', [cumulative_contributions], {
                yText: 'cumulative-contributions',
                attrX: 'day',
                attrY: 'count',
                tickEvery: d3.timeDay.every(60),
                timeFormat:"%b %y",
                legendData:[{color: 'crimson', name: 'votes'}]
            }, {});

            var ground_truth_not_from_propagation =
                JSON.parse('{{ num_ground_truth_per_day.num_ground_truth_not_from_propagation_per_day | safe }}');
            var ground_truth_from_propagation =
                JSON.parse('{{ num_ground_truth_per_day.num_ground_truth_from_propagation_per_day | safe }}');
            var total_ground_truth = [];
            // Assume that ground_truth_not_from_propagation and ground_truth_from_propagation have the same day counts
            for (var i=0 ; i<ground_truth_not_from_propagation.length ; i++) {
                total_ground_truth.push({
                    count: ground_truth_not_from_propagation[i].count + ground_truth_from_propagation[i].count,
                    day: ground_truth_not_from_propagation[i].day
                });
            }


            displayCharts('.ground-truth', [
                ground_truth_not_from_propagation,
                ground_truth_from_propagation,
                total_ground_truth], {
                    yText: 'annotations',
                    attrX: 'day',
                    attrY: 'count',
                    tickEvery: d3.timeDay.every(60),
                    timeFormat:"%b %y",
                    legendData:[{color: 'crimson', name: 'ground truth not from propagation'},
                                {color: 'blue', name: 'ground truth from propagation'},
                                {color: 'green', name: 'total ground truth'}]
                }, {});

            var cumulative_ground_truth_not_from_propagation = [];
            var cumulative_ground_truth_from_propagation = [];
            var cumulative_total_ground_truth = [];
            var total_count_ground_truth_not_from_propagation = 0;
            var total_count_ground_truth_from_propagation = 0;
            var total_count_total_ground_truth = 0;
            // this assumes that data counts are ordered by date asc
            for (i=0; i<ground_truth_not_from_propagation.length; i++) {
                total_count_ground_truth_not_from_propagation += ground_truth_not_from_propagation[i].count;
                cumulative_ground_truth_not_from_propagation.push({
                    day: ground_truth_not_from_propagation[i].day,
                    count: total_count_ground_truth_not_from_propagation
                });
                total_count_ground_truth_from_propagation += ground_truth_from_propagation[i].count;
                cumulative_ground_truth_from_propagation.push({
                    day: ground_truth_not_from_propagation[i].day,
                    count: total_count_ground_truth_from_propagation
                });
                total_count_total_ground_truth += total_ground_truth[i].count;
                cumulative_total_ground_truth.push({
                    day: ground_truth_not_from_propagation[i].day,
                    count: total_count_total_ground_truth
                });
            }

            displayCharts('.cumulative-ground-truth', [
                cumulative_ground_truth_not_from_propagation,
                cumulative_ground_truth_from_propagation,
                cumulative_total_ground_truth], {
                    yText: 'annotations',
                    attrX: 'day',
                    attrY: 'count',
                    tickEvery: d3.timeDay.every(60),
                    timeFormat:"%b %y",
                    legendData:[{color: 'crimson', name: 'ground truth not from propagation'},
                                {color: 'blue', name: 'ground truth from propagation'},
                                {color: 'green', name: 'total ground truth'}]
                }, {});


        });
    </script>
{% endblock %}

{% block content %}
    <h1 class="ui header">Monitor categories of {{dataset.short_name|upper}}</h1>
    <br>

    <div class="ui accordion">
        {#    NUMBER OF CONTRIBUTIONS    #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Number of contributions</h2>
            <span class="small_gray_text">Last updated {{ num_contributions_per_day.redis_timestamp | timestamp_to_datetime | timesince  }} ago</span>
        </div>
        <div class="content">
            <h3> Number of contributions per day </h3>
            <div class='contributions'></div>
            <h3> Cumulative number of contributions per day </h3>
            <div class='cumulative-contributions'></div>
        </div>
        <br>

        {#    NUMBER OF GROUND TRUTH    #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Number of ground truth annotations</h2>
            <span class="small_gray_text">Last updated {{ num_ground_truth_per_day.redis_timestamp | timestamp_to_datetime | timesince  }} ago</span>
        </div>
        <div class="content">
            <h3> Number of ground truth per day </h3>
            <div class='ground-truth'></div>
            <h3> Cumulative number of ground truth per day </h3>
            <div class='cumulative-ground-truth'></div>
        </div>
        <br>

        {#    TOP CONTRIBUTED CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Top contributed categories</h2>
            <span class="small_gray_text">Last updated {{ top_contributed.redis_timestamp | timestamp_to_datetime | timesince  }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Number of contributions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, num_votes, omitted in top_contributed.top_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ num_votes }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last week</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Number of contributions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, num_votes, omitted in top_contributed.top_categories_last_week %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ num_votes }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    BAD MAPPING CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Categories with bad mapping</h2>
            <span class="small_gray_text">Last updated {{ bad_mapping.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned"><div class="ui" data-tooltip="NP + U votes / Total votes">Bad mapping score</div></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, score, omitted in bad_mapping.bad_mapping_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ score | multiply:100 | floatformat:0 }} %</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last month</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned"><div class="ui" data-tooltip="NP + U votes / Total votes">Bad mapping score</div></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, score, omitted in bad_mapping.bad_mapping_categories_last_month %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ score | multiply:100 | floatformat:0 }} %</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    DIFFICULT AGREEMENT CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Categories with difficult agreement</h2>
            <span class="small_gray_text">Last updated {{ difficult_agreement.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Average num of votes until agreement</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, mean_num_votes, omitted in difficult_agreement.difficult_agreement_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ mean_num_votes | floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last month</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Average num of votes until agreement</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, mean_num_votes, omitted in difficult_agreement.difficult_agreement_categories_last_month %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ mean_num_votes | floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    REMAINING CANDIDATE ANNOTATIONS     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Candidate annotations left per categories (with duration groups)</h2>
            <span class="small_gray_text">Last updated {{ remaining_annotations.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <h3>All time</h3>
                <table class="ui unstackable table" width="100%">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th class="center aligned">Category name</th>
                        <th class="center aligned">Num candidate annotations left (<= 10 sec)</th>
                        <th class="center aligned">Num candidate annotations left (>10 & <= 20 sec)</th>
                        <th class="center aligned">Num candidate annotations left (total)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for url_id, node_name, num_total, num_10_sec, num_20_sec, omitted in remaining_annotations.remaining_categories %}
                        <tr {% if omitted %}class="negative"{% endif %}>
                            <td>{{ forloop.counter }}</td>
                            <td class="center aligned">
                                {% if forloop.counter == 1 %}
                                    <i class="yellow star icon"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="grey star icon"></i>
                                {% elif forloop.counter == 3 %}
                                    <i class="brown star icon"></i>
                                {% endif %}
                                <a class="" href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                    {{ node_name }}
                                </a>
                            </td>
                            <td class="center aligned">{{ num_10_sec }}</td>
                            <td class="center aligned">{{ num_20_sec }}</td>
                            <td class="center aligned">{{ num_total }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    <br>

        {#    Table for accessing categories     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Monitor individual categories</h2>
        </div>
        <div class="content">
            <table id="category-table" class="ui unstackable table" width="100%" style="margin-bottom:5px;">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for node in dataset.taxonomy.get_all_nodes %}
                    <tr {% if node.is_omitted %}class="negative"{% endif %}>
                        <td>{{ node.name }}</td>
                        <td class="right aligned"><a href="{% url 'monitor-category' dataset.short_name node.url_id %}" class="blue ui button right labeled icon">Go<i class="right arrow icon"></i></a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    <br>

    </div>

{% endblock %}