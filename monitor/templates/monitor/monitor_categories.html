{% extends "base.html" %}
{% load humanize %}
{% load general_templatetags %}
{% block title %}Monitor category page{% endblock title %}

{% block page_js %}
    <script type="text/javascript">
        $(document).ready(function(){
            $('.ui.accordion').accordion();
            $('#category-table').DataTable();
        });
    </script>
{% endblock %}

{% block content %}
    <h1 class="ui header">Monitor categories of {{dataset.short_name|upper}}</h1>
    <br>

    <div class="ui accordion">
        {#    TOP CONTRIBUTED CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Top contributed categories</h2>
            <span class="small_gray_text">Last updated {{ top_contributed.redis_timestamp | timestamp_to_datetime | timesince  }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Number of contributions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, num_votes, omitted in top_contributed.top_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ num_votes }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last week</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Number of contributions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, num_votes, omitted in top_contributed.top_categories_last_week %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ num_votes }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    BAD MAPPING CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Categories with bad mapping</h2>
            <span class="small_gray_text">Last updated {{ bad_mapping.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned"><div class="ui" data-tooltip="NP + U votes / Total votes">Bad mapping score</div></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, score, omitted in bad_mapping.bad_mapping_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ score | multiply:100 | floatformat:0 }} %</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last month</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned"><div class="ui" data-tooltip="NP + U votes / Total votes">Bad mapping score</div></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, score, omitted in bad_mapping.bad_mapping_categories_last_month %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ score | multiply:100 | floatformat:0 }} %</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    DIFFICULT AGREEMENT CATEGORIES     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Categories with difficult agreement</h2>
            <span class="small_gray_text">Last updated {{ difficult_agreement.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <div class="two column row">
                    <div class="column">
                        <h3>All time</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Average num of votes until agreement</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, mean_num_votes, omitted in difficult_agreement.difficult_agreement_categories %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ mean_num_votes | floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="column">
                        <h3>Last month</h3>
                        <table class="ui unstackable table" width="100%">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th class="center aligned">Category name</th>
                                <th class="center aligned">Average num of votes until agreement</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for url_id, node_name, mean_num_votes, omitted in difficult_agreement.difficult_agreement_categories_last_month %}
                                <tr {% if omitted %}class="negative"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="center aligned">
                                        {% if forloop.counter == 1 %}
                                            <i class="yellow star icon"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="grey star icon"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="brown star icon"></i>
                                        {% endif %}
                                        <a href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                            {{ node_name }}
                                        </a>
                                    </td>
                                    <td class="center aligned">{{ mean_num_votes | floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <br>

        {#    REMAINING CANDIDATE ANNOTATIONS     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Candidate annotations left per categories (with duration groups)</h2>
            <span class="small_gray_text">Last updated {{ remaining_annotations.redis_timestamp | timestamp_to_datetime | timesince }} ago</span>
        </div>
        <div class="content">
            <div class="ui grid">
                <h3>All time</h3>
                <table class="ui unstackable table" width="100%">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th class="center aligned">Category name</th>
                        <th class="center aligned">Num candidate annotations left (<= 10 sec)</th>
                        <th class="center aligned">Num candidate annotations left (>10 & <= 20 sec)</th>
                        <th class="center aligned">Num candidate annotations left (total)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for url_id, node_name, num_total, num_10_sec, num_20_sec, omitted in remaining_annotations.remaining_categories %}
                        <tr {% if omitted %}class="negative"{% endif %}>
                            <td>{{ forloop.counter }}</td>
                            <td class="center aligned">
                                {% if forloop.counter == 1 %}
                                    <i class="yellow star icon"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="grey star icon"></i>
                                {% elif forloop.counter == 3 %}
                                    <i class="brown star icon"></i>
                                {% endif %}
                                <a class="" href="{% url 'dataset-explore-taxonomy-node' dataset.short_name url_id %}" target="_blank">
                                    {{ node_name }}
                                </a>
                            </td>
                            <td class="center aligned">{{ num_10_sec }}</td>
                            <td class="center aligned">{{ num_20_sec }}</td>
                            <td class="center aligned">{{ num_total }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    <br>

        {#    Table for accessing categories     #}
        <div class="title">
            <h2 class="ui header"><i class="dropdown icon"></i> Monitor individual categories</h2>
        </div>
        <div class="content">
            <table id="category-table" class="ui unstackable table" width="100%" style="margin-bottom:5px;">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for node in dataset.taxonomy.get_all_nodes %}
                    <tr {% if node.is_omitted %}class="negative"{% endif %}>
                        <td>{{ node.name }}</td>
                        <td class="right aligned"><a href="{% url 'monitor-category' dataset.short_name node.url_id %}" class="blue ui button right labeled icon">Go<i class="right arrow icon"></i></a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    <br>

    </div>

{% endblock %}